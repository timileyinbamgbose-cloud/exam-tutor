# Deployment patch for 10x scale
# Phase 5: 10,000 concurrent users

apiVersion: apps/v1
kind: Deployment
metadata:
  name: examstutor-api
spec:
  replicas: 15  # Increased from 3 (5x base replicas)

  template:
    spec:
      # Use larger instance types
      nodeSelector:
        node.kubernetes.io/instance-type: c5.2xlarge  # 8 vCPU, 16GB RAM

      containers:
      - name: api
        resources:
          requests:
            cpu: "2000m"  # 2 CPU cores
            memory: "4Gi"
          limits:
            cpu: "4000m"  # 4 CPU cores max
            memory: "8Gi"

        env:
        # Database scaling
        - name: DATABASE_POOL_SIZE
          value: "100"  # Increased from 20
        - name: DATABASE_MAX_OVERFLOW
          value: "50"
        - name: DATABASE_POOL_TIMEOUT
          value: "30"

        # Redis caching
        - name: REDIS_ENABLED
          value: "true"
        - name: REDIS_CLUSTER
          value: "redis-cluster-headless:6379"
        - name: CACHE_TTL
          value: "3600"  # 1 hour

        # Performance tuning
        - name: WORKERS_PER_CORE
          value: "2"  # Gunicorn workers
        - name: MAX_REQUESTS
          value: "10000"
        - name: MAX_REQUESTS_JITTER
          value: "1000"
        - name: WORKER_TIMEOUT
          value: "120"

        # Rate limiting
        - name: RATE_LIMIT_ENABLED
          value: "true"
        - name: RATE_LIMIT_PER_MINUTE
          value: "120"  # 120 requests/min per user

        # Connection pooling
        - name: KEEP_ALIVE_TIMEOUT
          value: "65"

        # Enhanced monitoring
        - name: PROMETHEUS_ENABLED
          value: "true"
        - name: TRACING_ENABLED
          value: "true"
        - name: TRACING_SAMPLE_RATE
          value: "0.1"  # 10% sampling at scale

        # CDN
        - name: CDN_ENABLED
          value: "true"
        - name: CDN_URL
          value: "https://cdn.examstutor.ng"

        livenessProbe:
          httpGet:
            path: /health/live
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /health/ready
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        # Graceful shutdown
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 15"]  # Drain connections

      # Pod disruption budget awareness
      terminationGracePeriodSeconds: 60

      # Anti-affinity: Spread pods across nodes for HA
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - examstutor-api
              topologyKey: kubernetes.io/hostname
